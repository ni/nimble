# Implementation Plan: Lage Build Coordination

**Branch**: `003-build-coordination` | **Date**: November 26, 2025 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/003-build-coordination/spec.md`

## Summary

Extend Lage task orchestration to handle monorepo builds with intelligent caching and parallel execution, reducing full build time from ~10 minutes (sequential npm workspaces) to <5 seconds (warm cache) or ~3-4 minutes (cold cache with parallelism). This migration follows the established pattern from 001-replace-concurrently (Lage for validate/test) and 002-lint-speedup (Lage for linting), consolidating all build orchestration on a single tool with superior dependency management and caching capabilities.

## Technical Context

**Language/Version**: TypeScript 5.6, Node.js 22.14.0  
**Primary Dependencies**: Lage 2.14.15 (already installed), npm workspaces  
**Storage**: Local file-based cache (`.lage/cache/`)  
**Testing**: Existing package build scripts (tsc, rollup, vite, storybook, dotnet)  
**Target Platform**: macOS (arm64/x64), Linux, Windows (development + CI)  
**Project Type**: Monorepo infrastructure (23 workspace packages)  
**Performance Goals**: 
- Warm cache: <5 seconds full build (SC-001)
- Cold cache: <4 minutes local (4 workers), <3 minutes CI (8 workers) vs ~10 minutes sequential (SC-002)
- Incremental build: <30 seconds for single package change (SC-003)
- Cache hit rate: >90% on 1-3 package changes (SC-004)  
**Constraints**: 
- Must preserve `npm run build` command (backward compatibility)
- No CI workflow changes (SC-006)
- Must work across platforms (macOS arm64/x64, Linux, Windows)
- Must handle multi-step builds (e.g., nimble-components: icons → workers → compile → bundle → scss)
- Cache must be git-ignored (`.lage/cache/`)  
**Scale/Scope**: 
- 23 workspace packages with complex dependency graph
- Build times: 30s (light packages) to 90s (heavy packages) per package
- Multi-step builds: 4-5 steps in core packages (nimble-components, nimble-tokens, angular-workspace)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ I. Declarative-First Architecture
**Status**: PASS  
**Analysis**: Lage configuration is declarative (static pipeline definitions in `lage.config.js`). Build pipeline configuration follows the same pattern as existing test/validate/lint pipelines. All inputs/outputs are statically defined glob patterns. No runtime code generation. Cache invalidation based on file content hashes, not dynamic logic.

### ✅ II. Web Standards & Accessibility Compliance  
**Status**: N/A  
**Analysis**: Build orchestration infrastructure, not component code. No web standards or accessibility requirements apply.

### ✅ III. Package Independence & Boundaries
**Status**: PASS  
**Analysis**: 
- Lage configuration lives at repo root (appropriate for cross-package orchestration)
- Individual package build scripts remain unchanged (`package.json` build scripts)
- No cross-package imports introduced
- Build dependencies declared in `package.json` (explicit)
- Shared infrastructure (Lage) is acceptable pattern for monorepo tooling

### ✅ IV. FAST Foundation Alignment
**Status**: N/A  
**Analysis**: Build tooling infrastructure, not component implementation. FAST Foundation principles don't apply.

### ✅ V. Static & Explicit Philosophy
**Status**: PASS  
**Analysis**: 
- Lage pipeline configuration is explicit and static (no dynamic pipeline generation)
- Input/output globs are literal patterns, not computed
- Weight calculation reuses existing `resolveWeight` function from lint/test pipelines (simple lookup)
- Build dependencies expressed via `dependsOn: ['^build']` (clear, standard pattern)
- Cache keys generated by Lage's built-in hash function (standard, well-tested)

### ✅ VI. Comprehensive Quality Assurance
**Status**: PASS  
**Analysis**: 
- **Testing strategy**: Validate migration by running existing build workflows through Lage orchestration
- **Performance testing**: Measure warm/cold cache times against success criteria (SC-001 to SC-004)
- **Cross-platform**: Test on macOS (arm64), Linux (CI), verify Windows compatibility via CI
- **Beachball change file**: Required (changes root `package.json`)
- **Manual validation**: 
  1. Full build from clean repo (cold cache)
  2. Incremental build (change one package)
  3. Warm cache (no changes)
  4. Scoped builds (`--scope`, `--since`)
  5. Error handling (introduce build failure, verify fail-fast)
- **Rollback plan**: Git revert + cache clear documented in research.md

**Constitution Verdict**: ✅ ALL GATES PASS - No violations. Proceed to Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/003-build-coordination/
├── spec.md                          # Feature specification (COMPLETE)
├── plan.md                          # This file (IN PROGRESS)
├── research.md                      # Phase 0: Research (COMPLETE)
├── quickstart.md                    # Phase 1: Migration guide (COMPLETE)
├── checklists/
│   └── requirements.md              # Spec quality checklist (COMPLETE)
└── tasks.md                         # Phase 2: Implementation tasks (PENDING)
```

### Source Code (repository root)

```text
nimble-worktrees/lint-plan-worktree/
├── lage.config.js                   # MODIFY: Add build pipeline
├── package.json                     # MODIFY: Update build script to use Lage
├── package-lock.json                # AUTO-UPDATE: No dependency changes
├── .lage/
│   ├── cache/                       # AUTO-GENERATED: Build cache (git-ignored)
│   └── logs/                        # AUTO-GENERATED: Build logs (git-ignored)
├── scripts/
│   └── lint/
│       ├── workspaces.json          # REVIEW: Existing weights apply to build
│       └── README.md                # UPDATE: Document build orchestration
├── packages/
│   ├── nimble-components/
│   │   └── package.json             # NO CHANGE: build script stays same
│   ├── nimble-tokens/
│   │   └── package.json             # NO CHANGE: build script stays same
│   ├── angular-workspace/
│   │   └── package.json             # NO CHANGE: build script stays same
│   └── [all other packages]/
│       └── package.json             # NO CHANGE: build scripts stay same
└── .github/
    └── workflows/
        └── *.yml                    # NO CHANGE: LAGE_CONCURRENCY=8 already set
```

**Structure Decision**: Infrastructure-only changes. Lage configuration at repo root orchestrates package-level builds. Individual packages keep their existing multi-step build scripts. No new source code. Follows exact same pattern as 001-replace-concurrently (validate/test pipelines) and 002-lint-speedup (lint pipeline).

## Complexity Tracking

> **This section is empty because Constitution Check has no violations requiring justification.**

---

## Phase 0: Outline & Research ✅ COMPLETE

### Unknowns Resolved

All technical unknowns from feature spec have been researched and resolved in [research.md](./research.md):

1. ✅ **Current build system analysis**: Sequential npm workspaces, ~10 min, no caching
2. ✅ **Lage pipeline configuration**: Add `build` pipeline following test/validate pattern
3. ✅ **Multi-step build handling**: Lage invokes top-level `build` script; packages handle internal steps
4. ✅ **Cache invalidation strategy**: Hash-based using source files, configs, dependencies
5. ✅ **Parallel execution safety**: 4 workers local, 8 CI; weight-based allocation prevents OOM
6. ✅ **CI integration**: No changes needed, LAGE_CONCURRENCY=8 already set
7. ✅ **Error handling**: Lage's fail-fast default matches requirements
8. ✅ **Watch mode**: Keep existing package-specific scripts (out of scope)
9. ✅ **Scoped builds**: Built-in --scope and --since flags work out-of-the-box
10. ✅ **Migration/rollback**: Single-step migration, git revert + cache clear for rollback

### Technology Decisions

| Technology | Purpose | Justification |
|------------|---------|---------------|
| Lage 2.14.15 | Build orchestration | Already installed, proven pattern from lint/test/validate |
| Local cache | Build output caching | Simple, no infrastructure, meets MVP requirements |
| Weight system | Memory-safe parallelism | Existing system from lint/test pipelines, no new config |
| npm workspaces | Package discovery | Existing monorepo structure, no changes needed |

---

## Phase 1: Design & Contracts ✅ COMPLETE

### Data Model

**N/A for build orchestration infrastructure**. No persistent data entities. Lage manages ephemeral build state:

- **Build tasks**: In-memory during execution, not persisted
- **Cache entries**: File-based (`.lage/cache/`), managed by Lage
- **Dependency graph**: Computed from `package.json` files, not stored

See [research.md](./research.md) for cache key composition and invalidation logic.

### API Contracts

**N/A for build tooling**. No HTTP/RPC APIs. Command-line interface provided by Lage:

**Public CLI** (available to contributors):
```bash
# Standard build command (unchanged)
npm run build

# Advanced: Scoped builds
lage run build --scope <package>
lage run build --since <git-ref>

# Troubleshooting
lage run build --verbose
lage run build --dry-run
rm -rf .lage/cache  # Clear cache
```

**Internal Configuration** (lage.config.js pipeline):
```javascript
pipeline: {
  build: {
    dependsOn: ['^build'],  // Build dependencies first
    cache: true,            // Enable caching
    inputs: [...],          // Cache invalidation inputs
    outputs: [...],         // Files to cache
    weight: resolveWeight   // Memory allocation
  }
}
```

See [research.md](./research.md) section 2 for complete configuration schema.

### Developer Quickstart

See [quickstart.md](./quickstart.md) for complete migration guide covering:
- Basic usage (no changes to `npm run build`)
- Advanced scoped builds (`--scope`, `--since`)
- Troubleshooting (cache clearing, verbose output)
- Understanding cache behavior
- Parallel execution and concurrency tuning
- Watch mode (unchanged, package-specific)
- Dependency graph visualization
- Common workflows (development, PR review, pulling main)

---

## Phase 2: Implementation Tasks

### Task Breakdown (High-Level)

Detailed tasks will be created in `tasks.md` by `/speckit.implement` command. High-level phases:

#### Phase 1: Configuration (T001-T005)
- T001: Add build pipeline to `lage.config.js`
- T002: Update root `package.json` build script
- T003: Verify cache configuration
- T004: Test build orchestration locally
- T005: Create beachball change file

#### Phase 2: Documentation (T006-T008)
- T006: Update `scripts/lint/README.md`
- T007: Verify `quickstart.md` accuracy
- T008: Update CONTRIBUTING.md if needed

#### Phase 3: Validation (T009-T015)
- T009: Cold cache build test (measure time)
- T010: Warm cache build test (verify <5s)
- T011: Incremental build test (change one package)
- T012: Scoped build test (`--scope`, `--since`)
- T013: Error handling test (build failure)
- T014: Cross-platform test (macOS, Linux via CI)
- T015: Performance benchmark (compare vs sequential)

#### Phase 4: CI Integration (T016-T018)
- T016: Verify CI builds with LAGE_CONCURRENCY=8
- T017: Measure CI build time improvement
- T018: Test rollback procedure

#### Phase 5: Communication (T019-T020)
- T019: Create PR with detailed description
- T020: Announce in Slack with quickstart link

**Estimated Effort**: 4-6 hours (2-3 hours config + testing, 1-2 hours validation, 1 hour communication)

---

## Success Criteria Validation Plan

| ID | Criteria | Validation Method | Target | Measured By |
|----|----------|-------------------|--------|-------------|
| SC-001 | Warm cache <5s | Run `npm run build` twice, time second run | <5s | `time` command or Lage output |
| SC-002 | Cold cache <4min local, <3min CI | Clear cache, run full build | <4min / <3min | `time` command or Lage output |
| SC-003 | Incremental build <30s | Change one package, run build | <30s | `time` command or Lage output |
| SC-004 | Cache hit rate >90% | Change 1-3 packages, count cache hits/misses | >90% | Lage `--verbose` output |
| SC-005 | ≥4 workers local, ≥8 CI | Observe concurrent builds | ≥4 / ≥8 | Lage output showing parallel tasks |
| SC-006 | CI unchanged | Review workflow YAML diffs | No changes | Git diff |
| SC-007 | Clear error messages | Introduce build failure, verify output | Readable error | Manual review of error output |

---

## Risk Assessment & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Cache corruption causes incorrect builds | Low | High | Clear cache command documented; validate with fresh builds |
| OOM errors from excessive parallelism | Low | Medium | Weight system limits concurrent heavy packages |
| Breaking existing build workflows | Low | High | Thorough testing; rollback plan via git revert |
| Cache invalidation misses changes | Low | High | Comprehensive input globs; validate with incremental tests |
| CI performance regression | Very Low | Medium | CI uses 8 workers (vs 4 local); benchmark before merge |
| Developer confusion about new workflow | Medium | Low | No workflow changes; quickstart guide + Slack announcement |

---

## Open Questions

**All questions resolved in research phase. No blockers.**

---

## Post-Implementation

### Monitoring

- Track build times in CI (GitHub Actions metrics)
- Monitor cache hit rates (Lage logs)
- Collect developer feedback on build performance

### Future Enhancements (Out of Scope for MVP)

1. **Remote caching**: GitHub Actions cache or Azure Blob Storage
   - Would further reduce CI build times
   - Requires infrastructure setup + workflow changes

2. **Watch mode orchestration**: Lage-coordinated watch builds
   - Would provide unified watch experience
   - TypeScript's `tsc -w` is currently faster for incremental compilation

3. **Build telemetry**: Metrics dashboard for build performance
   - Would help identify slow packages
   - Low priority, manual monitoring sufficient for now

4. **Build output validation**: Verify outputs match expectations
   - Would catch silent build issues
   - Tests currently provide sufficient coverage

---

## References

- [Feature Specification](./spec.md) - Requirements and user stories
- [Research Document](./research.md) - Technical decisions and alternatives
- [Quickstart Guide](./quickstart.md) - Contributor migration guide
- [Lage Documentation](https://microsoft.github.io/lage/) - Official Lage docs
- [001-replace-concurrently](../001-replace-concurrently/) - Prior Lage integration (validate/test)
- [002-lint-speedup](../002-lint-speedup/) - Prior Lage integration (lint)
- [Nimble CONTRIBUTING.md](/CONTRIBUTING.md) - Repository guidelines
